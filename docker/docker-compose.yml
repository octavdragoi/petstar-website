services:
  # Static website web server
  web:
    image: nginx:alpine
    container_name: petstar-web
    ports:
      - "8081:80"
    volumes:
      - ../:/usr/share/nginx/html:ro,z
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro,z
    depends_on:
      - strapi
    networks:
      - petstar-network
    restart: unless-stopped

  # Strapi CMS
  strapi:
    build:
      context: ../petstar-cms
      dockerfile: Dockerfile
    container_name: petstar-strapi
    env_file:
      - ../petstar-cms/.env
    ports:
      - "1337:1337"
    environment:
      - STRAPI_CORS_ENABLED=true
      - STRAPI_CORS_ORIGIN=http://localhost:1337,http://localhost:8081,http://127.0.0.1:8081,https://petstar.ro,https://petstar-dash.ro,https://api.petstar-dash.ro
    volumes:
      - ../petstar-cms/src:/opt/app/src:z
      - ../petstar-cms/config:/opt/app/config:z
      - ../petstar-cms/database:/opt/app/database:z
      - ../petstar-cms/public:/opt/app/public:z
      - ../petstar-cms/.tmp:/opt/app/.tmp:z
    networks:
      - petstar-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:1337/_health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s


  #  Cloudflare tunnel
  cloudflared:
    image: cloudflare/cloudflared
    restart: unless-stopped
    command: tunnel run
    network_mode: "host"
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN} # stored in .env file

networks:
  petstar-network:
    driver: bridge
